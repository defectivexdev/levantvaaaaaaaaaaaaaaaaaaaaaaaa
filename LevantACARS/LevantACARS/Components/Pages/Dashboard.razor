@inject DashboardViewModel VM
@inject FlightViewModel FVM
@implements IDisposable

<div style="display:flex; flex-direction:column; height:100%;">

    <!-- ═══ Flight Info Bar (when flight active) ════════════════════ -->
    @if (FVM.IsFlightActive)
    {
        <div class="flight-info-bar" style="margin:12px 14px 0 14px;">
            <div class="flex items-center gap-3">
                <span style="font-size:15px; font-weight:700; color:var(--accent);">@FVM.FlightNumber</span>
                <span style="font-size:13px; color:var(--text-secondary);">
                    @FVM.DepartureIcao
                    <span class="text-disabled"> → </span>
                    @FVM.ArrivalIcao
                </span>
                <span class="badge badge-accent">@FVM.CurrentPhase</span>
                <span class="badge badge-gold">@FVM.FlightTime</span>
            </div>
            <button class="btn btn-danger" style="font-size:10px; padding:6px 14px;" @onclick="OnEndFlight">
                END FLIGHT
            </button>
        </div>
    }

    <!-- ═══ Score Card (after flight) ══════════════════════════════ -->
    @if (FVM.ShowScoreCard)
    {
        <div class="card" style="margin:12px 14px 0 14px; padding:16px 18px;">
            <div class="label mb-3">FLIGHT REPORT</div>
            <div class="score-grid mb-2">
                <div class="score-item">
                    <div class="label mb-1">SCORE</div>
                    <div class="score-value text-accent">@(FVM.FinalScore)%</div>
                </div>
                <div class="score-item">
                    <div class="label mb-1">LANDING</div>
                    <div class="score-value text-gold">@FVM.LandingGrade</div>
                </div>
                <div class="score-item">
                    <div class="label mb-1">XP EARNED</div>
                    <div class="score-value text-success">+@FVM.XpEarned</div>
                </div>
            </div>
            <div style="font-size:11px; color:var(--text-secondary);">@FVM.LandingDescription</div>
            @if (FVM.FlightRejected)
            {
                <div style="font-size:11px; color:var(--danger); font-weight:600; margin-top:4px;">@FVM.RejectionReason</div>
            }
        </div>
    }

    <!-- ═══ Main Scrollable Content ════════════════════════════════ -->
    <div style="flex:1; overflow-y:auto; padding:12px 14px;">

        <!-- Aircraft + Phase -->
        <div class="card mb-3" style="padding:14px 18px;">
            <div class="flex items-center justify-between">
                <div>
                    <div class="label mb-1">AIRCRAFT</div>
                    <div style="font-size:14px; font-weight:600; color:var(--text-primary);">@VM.AircraftTitle</div>
                </div>
                <div class="flex gap-2">
                    <span class="badge badge-accent">@VM.Phase</span>
                    @if (VM.OnGround)
                    {
                        <span class="badge badge-gold">GROUND</span>
                    }
                    else
                    {
                        <span class="badge badge-success">AIRBORNE</span>
                    }
                </div>
            </div>
        </div>

        <!-- Primary Telemetry -->
        <div class="telem-grid telem-grid-4 mb-2">
            <div class="card">
                <div class="label mb-1">ALT</div>
                <div>
                    <span class="value">@VM.Altitude.ToString("N0")</span>
                    <span class="unit">ft</span>
                </div>
            </div>
            <div class="card">
                <div class="label mb-1">GS</div>
                <div>
                    <span class="value">@VM.GroundSpeed</span>
                    <span class="unit">kts</span>
                </div>
            </div>
            <div class="card">
                <div class="label mb-1">IAS</div>
                <div>
                    <span class="value">@VM.Ias</span>
                    <span class="unit">kts</span>
                </div>
            </div>
            <div class="card">
                <div class="label mb-1">V/S</div>
                <div>
                    <span class="value" style="color: var(@VsColor);">@FormatVs(VM.VerticalSpeed)</span>
                    <span class="unit">fpm</span>
                </div>
            </div>
        </div>

        <!-- Secondary Telemetry -->
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1.5fr; gap:6px; margin-bottom:8px;">
            <div class="card">
                <div class="label mb-1">HDG</div>
                <div>
                    <span class="value-lg">@VM.Heading.ToString("000")</span>
                    <span style="font-size:14px; color:var(--text-disabled);">°</span>
                </div>
            </div>
            <div class="card">
                <div class="label mb-1">G-FORCE</div>
                <span class="value-lg">@VM.GForce.ToString("F2")</span>
                <span class="unit">G</span>
            </div>
            <div class="card">
                <div class="label mb-1">ENGINES</div>
                @if (VM.EnginesOn)
                {
                    <span class="value-sm text-success">RUNNING</span>
                }
                else
                {
                    <span class="value-sm text-danger">OFF</span>
                }
            </div>
            <div class="card">
                <div class="label mb-1">POSITION</div>
                <span style="font-size:12px; font-family:var(--font-mono); color:var(--text-primary);">
                    @VM.Latitude.ToString("F5")
                    <span class="text-disabled">,</span>
                    @VM.Longitude.ToString("F5")
                </span>
            </div>
        </div>

        <!-- Flight-active panels: Comfort + Violations + Logs -->
        @if (FVM.IsFlightActive)
        {
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px;">
                <div class="card">
                    <div class="label mb-1">COMFORT</div>
                    <div class="flex items-center gap-3">
                        <span class="value-lg text-success">@(FVM.ComfortScore)%</span>
                        <div style="flex:1;">
                            <div class="progress-track">
                                <div class="progress-fill" style="width: @(FVM.ComfortScore)%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="label mb-1">VIOLATIONS</div>
                    <span class="value-lg text-warning">@FVM.ExceedanceCount</span>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px;">
                <div class="card" style="display:flex; flex-direction:column; min-height:0;">
                    <div class="label mb-2">ACTIVITY LOG</div>
                    <ul class="log-list" style="flex:1;">
                        @foreach (var entry in FVM.ActivityLog)
                        {
                            <li>@entry</li>
                        }
                    </ul>
                </div>
                <div class="card" style="display:flex; flex-direction:column; min-height:0;">
                    <div class="flex items-center gap-2 mb-2">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="var(--warning)">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 6h2v6h-2V7zm0 8h2v2h-2v-2z"/>
                        </svg>
                        <span class="label text-warning" style="margin:0;">EXCEEDANCES</span>
                    </div>
                    <ul class="log-list" style="flex:1;">
                        @foreach (var exc in FVM.ExceedanceLog)
                        {
                            <li>@exc</li>
                        }
                    </ul>
                </div>
            </div>
        }
    </div>

    <!-- ═══ Bottom Bar ═════════════════════════════════════════════ -->
    <div class="bottom-bar">
        <div class="flex items-center gap-2">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="var(--text-disabled)">
                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
            </svg>
            <span>@VM.Latitude.ToString("F4")  @VM.Longitude.ToString("F4")</span>
        </div>
        @if (FVM.IsFlightActive)
        {
            <button class="btn-ghost danger" style="font-size:9px; padding:4px 8px;" @onclick="OnCancelFlight">Cancel Flight</button>
        }
    </div>
</div>

@code {
    private string VsColor => VM.VerticalSpeed > 0 ? "--success" : VM.VerticalSpeed < 0 ? "--danger" : "--text-disabled";

    private string FormatVs(int vs)
    {
        if (vs > 0) return $"+{vs}";
        if (vs < 0) return vs.ToString();
        return "0";
    }

    protected override void OnInitialized()
    {
        VM.PropertyChanged += OnVmChanged;
        FVM.PropertyChanged += OnVmChanged;
        FVM.ActivityLog.CollectionChanged += OnCollectionChanged;
        FVM.ExceedanceLog.CollectionChanged += OnCollectionChanged;
    }

    private async void OnVmChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    private async void OnCollectionChanged(object? sender, System.Collections.Specialized.NotifyCollectionChangedEventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnEndFlight() => await FVM.SubmitFlightCommand.ExecuteAsync(null);
    private async Task OnCancelFlight() => await FVM.CancelFlightCommand.ExecuteAsync(null);

    public void Dispose()
    {
        VM.PropertyChanged -= OnVmChanged;
        FVM.PropertyChanged -= OnVmChanged;
        FVM.ActivityLog.CollectionChanged -= OnCollectionChanged;
        FVM.ExceedanceLog.CollectionChanged -= OnCollectionChanged;
    }
}
