@inject FlightViewModel VM
@implements IDisposable

@if (!VM.IsFlightActive)
{
    <!-- ═══ DISPATCH FORM (no active flight) ═════════════════════════ -->
    <div style="padding: 24px; max-width: 720px;">

        <!-- Header -->
        <div style="margin-bottom: 20px; padding-left: 4px;">
            <div class="heading">Flight Dispatch</div>
            <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                Configure your flight plan or load from an active booking
            </div>
        </div>

        <!-- Score Card (post-flight result) -->
        @if (VM.ShowScoreCard)
        {
            <div class="card mb-4" style="padding: 24px;">
                <div class="label mb-4">FLIGHT REPORT</div>
                <div class="score-grid mb-3">
                    <div class="score-item">
                        <div class="label mb-2">SCORE</div>
                        <div class="score-value text-accent">@(VM.FinalScore)%</div>
                    </div>
                    <div class="score-item">
                        <div class="label mb-2">LANDING</div>
                        <div class="score-value text-gold">@VM.LandingGrade</div>
                    </div>
                    <div class="score-item">
                        <div class="label mb-2">XP EARNED</div>
                        <div class="score-value text-success">+@VM.XpEarned</div>
                    </div>
                </div>
                <div style="font-size:12px; color:var(--text-secondary);">@VM.LandingDescription</div>
                @if (VM.FlightRejected)
                {
                    <div style="font-size:12px; color:var(--danger); font-weight:600; margin-top:4px;">
                        @VM.RejectionReason
                    </div>
                }
            </div>
        }

        <!-- Dispatch Form -->
        <div class="card" style="padding: 28px;">
            <div style="display:flex; flex-direction:column; gap:12px;">

                <!-- Row 0: Pilot ID / Flight Number -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Pilot ID</label>
                        <input class="form-input" placeholder="LVA001"
                               @bind="VM.PilotId" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Flight Number</label>
                        <input class="form-input" placeholder="LVA123"
                               @bind="VM.FlightNumber" @bind:event="oninput" />
                    </div>
                </div>

                <!-- Row 1: Callsign / Aircraft Type -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Callsign</label>
                        <input class="form-input" placeholder="LVA123"
                               @bind="VM.Callsign" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Aircraft Type</label>
                        <input class="form-input" placeholder="A320"
                               @bind="VM.AircraftType" @bind:event="oninput" />
                    </div>
                </div>

                <!-- Row 2: DEP / ARR -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Departure ICAO</label>
                        <input class="form-input uppercase" placeholder="OLBA"
                               @bind="VM.DepartureIcao" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Arrival ICAO</label>
                        <input class="form-input uppercase" placeholder="OERK"
                               @bind="VM.ArrivalIcao" @bind:event="oninput" />
                    </div>
                </div>

                <!-- Row 3: Route -->
                <div class="form-group">
                    <label class="form-label">Route</label>
                    <input class="form-input" placeholder="DCT LATEB UL602 DESDI"
                           @bind="VM.Route" @bind:event="oninput" />
                </div>

                <!-- Row 4: Registration / PAX / Cargo -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Registration</label>
                        <input class="form-input uppercase" placeholder="OD-LVA"
                               @bind="VM.AircraftRegistration" @bind:event="oninput" />
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div class="form-group">
                            <label class="form-label">PAX</label>
                            <input class="form-input" type="number" placeholder="180"
                                   @bind="VM.Pax" @bind:event="oninput" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cargo (kg)</label>
                            <input class="form-input" type="number" placeholder="2500"
                                   @bind="VM.Cargo" @bind:event="oninput" />
                        </div>
                    </div>
                </div>

                <!-- Start Button -->
                <button class="btn btn-primary btn-full mt-3" style="height:48px; font-size:15px;"
                        @onclick="OnStartFlight">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.8 19.2L16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/>
                    </svg>
                    START FLIGHT
                </button>
            </div>
        </div>
    </div>
}
else
{
    <!-- ═══ LIVE FLIGHT PANEL ════════════════════════════════════════ -->
    <div style="display:flex; flex-direction:column; height:100%;">

        <!-- Flight Info Bar -->
        <div class="flight-info-bar">
            <div>
                <div class="flex items-center gap-3">
                    <span style="font-size:17px; font-weight:700; color:var(--accent);">@VM.FlightNumber</span>
                    <span style="font-size:17px; color:var(--text-secondary);">
                        @VM.DepartureIcao
                        <span class="text-disabled"> → </span>
                        @VM.ArrivalIcao
                    </span>
                </div>
                <div class="flex gap-2 mt-2">
                    <span class="badge badge-accent">@VM.CurrentPhase</span>
                    <span class="badge badge-gold">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" style="margin-right:3px;">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/>
                            <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
                        </svg>
                        @VM.FlightTime
                    </span>
                </div>
            </div>
            <button class="btn btn-danger" style="height:36px; font-size:12px;" @onclick="OnSubmitFlight">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M2.5 19h19v2h-19zm7.18-5.73l4.35 1.16 5.31 1.42c.8.21 1.62-.26 1.84-1.06.21-.8-.26-1.62-1.06-1.84l-5.31-1.42-2.76-9.02L10.12 2v8.28L5.15 8.95l-.93-2.32-1.45-.39v5.17l1.6.43 5.31 1.43z"/>
                </svg>
                END FLIGHT
            </button>
        </div>

        <!-- Main Content -->
        <div style="flex:1; overflow-y:auto; padding:12px 16px 8px 16px;">
            <div style="display:grid; grid-template-columns:1fr 280px; gap:8px; height:100%;">

                <!-- Left: Telemetry + Activity Log -->
                <div style="display:flex; flex-direction:column; gap:8px;">

                    <!-- Primary Telemetry -->
                    <div class="telem-grid telem-grid-4">
                        <div class="card">
                            <div class="label mb-2">ALT</div>
                            <span class="value-lg">@VM.Altitude.ToString("N0")</span>
                            <span class="unit">ft</span>
                        </div>
                        <div class="card">
                            <div class="label mb-2">GS</div>
                            <span class="value-lg">@VM.GroundSpeed</span>
                            <span class="unit">kts</span>
                        </div>
                        <div class="card">
                            <div class="label mb-2">V/S</div>
                            <span class="value-lg" style="color: var(@VsColor);">@FormatVs(VM.VerticalSpeed)</span>
                            <span class="unit">fpm</span>
                        </div>
                        <div class="card">
                            <div class="label mb-2">HDG</div>
                            <span class="value-lg">@(VM.Heading.ToString("000"))°</span>
                        </div>
                    </div>

                    <!-- Secondary Telemetry -->
                    <div class="telem-grid telem-grid-4">
                        <div class="card">
                            <div class="label mb-2">IAS</div>
                            <span class="value-lg">@VM.Ias</span>
                            <span class="unit">kts</span>
                        </div>
                        <div class="card">
                            <div class="label mb-2">G-FORCE</div>
                            <span class="value-lg">@VM.GForce.ToString("F2") G</span>
                        </div>
                        <div class="card">
                            <div class="label mb-2">COMFORT</div>
                            <span class="value-lg text-success">@(VM.ComfortScore)%</span>
                        </div>
                        <div class="card">
                            <div class="label mb-2">VIOLATIONS</div>
                            <span class="value-lg text-warning">@VM.ExceedanceCount</span>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="card flex-1" style="padding:16px 14px; display:flex; flex-direction:column; min-height:0;">
                        <div class="label mb-2">ACTIVITY LOG</div>
                        <ul class="log-list" style="flex:1;">
                            @foreach (var entry in VM.ActivityLog)
                            {
                                <li>@entry</li>
                            }
                        </ul>
                    </div>
                </div>

                <!-- Right: Exceedance Log -->
                <div class="card" style="padding:16px 14px; display:flex; flex-direction:column; min-height:0;">
                    <div class="flex items-center gap-2 mb-2">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="var(--warning)">
                            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-1 6h2v6h-2V7zm0 8h2v2h-2v-2z"/>
                        </svg>
                        <span class="label text-warning" style="margin:0;">EXCEEDANCES</span>
                    </div>
                    <ul class="log-list" style="flex:1;">
                        @foreach (var exc in VM.ExceedanceLog)
                        {
                            <li>@exc</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <!-- Bottom Bar -->
        <div class="bottom-bar">
            <div class="flex items-center gap-2">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="var(--text-disabled)">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
                <span>@VM.Latitude.ToString("F4")  @VM.Longitude.ToString("F4")</span>
            </div>
            <button class="btn-ghost danger" @onclick="OnCancelFlight">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right:4px;">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
                Cancel Flight
            </button>
        </div>
    </div>
}

@code {
    private string VsColor => VM.VerticalSpeed > 0 ? "--success" : VM.VerticalSpeed < 0 ? "--danger" : "--text-disabled";

    private string FormatVs(int vs)
    {
        if (vs > 0) return $"+{vs}";
        if (vs < 0) return vs.ToString();
        return "0";
    }

    protected override void OnInitialized()
    {
        VM.PropertyChanged += OnVmChanged;
        VM.ActivityLog.CollectionChanged += OnCollectionChanged;
        VM.ExceedanceLog.CollectionChanged += OnCollectionChanged;
    }

    private async void OnVmChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    private async void OnCollectionChanged(object? sender, System.Collections.Specialized.NotifyCollectionChangedEventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnStartFlight() => await VM.StartFlightCommand.ExecuteAsync(null);
    private async Task OnSubmitFlight() => await VM.SubmitFlightCommand.ExecuteAsync(null);
    private async Task OnCancelFlight() => await VM.CancelFlightCommand.ExecuteAsync(null);

    public void Dispose()
    {
        VM.PropertyChanged -= OnVmChanged;
        VM.ActivityLog.CollectionChanged -= OnCollectionChanged;
        VM.ExceedanceLog.CollectionChanged -= OnCollectionChanged;
    }
}
