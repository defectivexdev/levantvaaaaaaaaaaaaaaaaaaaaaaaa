name: Build ACARS MSI Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: version
      run: |
        if ($env:GITHUB_REF -match 'refs/tags/v(.+)') {
          $version = $matches[1]
        } else {
          $version = "1.2.2"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Building version: $version"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Restore NuGet packages
      run: nuget restore LevantACARS/LevantACARS.sln

    - name: Build ACARS Client
      run: msbuild LevantACARS/LevantACARS.sln /p:Configuration=Release /p:Platform="Any CPU"

    - name: Setup WiX Toolset v3
      run: |
        choco install wixtoolset -y
        echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Publish ACARS Client
      run: dotnet publish LevantACARS/LevantACARS/LevantACARS.csproj -c Release -r win-x64 --self-contained -o LevantACARS/installer/publish

    - name: Create default config.json template
      shell: pwsh
      run: |
        $config = @{
          api_base_url = "${{ secrets.BASE_URL }}/api/acars"
          app_key = "${{ secrets.APP_KEY }}"
          va_api_key = "LEVANTVIRTUALAIRLINE_WEBI_ACARS"
          api_timeout = 15
          ivao_client_id = "${{ secrets.IVAO_CLIENT_ID }}"
          ivao_client_secret = "${{ secrets.IVAO_CLIENT_SECRET }}"
          poll_interval_ms = 200
          heartbeat_interval_ms = 30000
          telemetry_buffer_interval = 4
          position_update_interval = 5
          discord_client_id = "${{ secrets.DISCORD_CLIENT_ID }}"
          cloudinary_cloud_name = "${{ secrets.CLOUDINARY_CLOUD_NAME }}"
          airportdb_api_token = "${{ secrets.AIRPORTDB_API_TOKEN }}"
          log_level = "Information"
          auth_token = $null
          pilot_id = $null
          pilot_name = $null
          pilot_rank = $null
          pilot_avatar = $null
          pilot_hours = 0
          pilot_xp = 0
          weight_unit = "lbs"
        }
        $configJson = $config | ConvertTo-Json -Depth 10
        $configJson | Set-Content "LevantACARS/LevantACARS/config.default.json"
        Write-Host "Created config.default.json with production settings"

    - name: Copy favicon.ico from React UI
      shell: pwsh
      run: |
        $source = "LevantACARS/react-ui/public/img/favicon.ico"
        $dest = "LevantACARS/LevantACARS/Assets/favicon.ico"
        if (-not (Test-Path $source)) { throw "favicon.ico not found at $source" }
        Copy-Item $source $dest -Force
        Write-Host "Copied favicon.ico from React UI to Assets folder"

    - name: Build MSI Installer
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        cd LevantACARS/installer
        
        # Harvest all published files
        heat.exe dir publish -cg PublishedFiles -gg -sfrag -srd -dr INSTALLDIR -out HarvestedFiles.wxs
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        
        # Compile WiX sources
        candle.exe -ext WixUIExtension -ext WixUtilExtension Package.wxs HarvestedFiles.wxs
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        
        # Link into MSI with base directory set to publish folder
        light.exe -ext WixUIExtension -ext WixUtilExtension -sval -b publish Package.wixobj HarvestedFiles.wixobj -o "LevantACARS-$version.msi"
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

    - name: Upload MSI Artifact
      uses: actions/upload-artifact@v4
      with:
        name: LevantACARS-Installer-v${{ steps.version.outputs.VERSION }}
        path: LevantACARS/installer/LevantACARS-${{ steps.version.outputs.VERSION }}.msi

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: LevantACARS/installer/LevantACARS-${{ steps.version.outputs.VERSION }}.msi
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
